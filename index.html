<!DOCTYPE html SYSTEM "about:legacy-compat">
<html lang="en-US" data-preset="contrast" data-primary-color="#307FFF"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta name="robots" content="noindex"><meta name="built-on" content="2025-04-01T21:40:22.711875"><title>Instrumenting the vSphere Kubernetes Node Image | test-02</title><script type="application/json" id="virtual-toc-data">[{"id":"before-you-start","level":0,"title":"Before you start","anchor":"#before-you-start"},{"id":"instrumenting-the-vks-node-image","level":0,"title":"Instrumenting the VKS Node Image","anchor":"#instrumenting-the-vks-node-image"}]</script><script type="application/json" id="topic-shortcuts"></script><link href="https://resources.jetbrains.com/writerside/apidoc/6.22.0-b725/app.css" rel="stylesheet"><meta name="msapplication-TileColor" content="#000000"><link rel="apple-touch-icon" sizes="180x180" href="https://jetbrains.com/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://jetbrains.com/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://jetbrains.com/favicon-16x16.png"><meta name="msapplication-TileImage" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-144x144.png"><meta name="msapplication-square70x70logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-70x70.png"><meta name="msapplication-square150x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-150x150.png"><meta name="msapplication-wide310x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x150.png"><meta name="msapplication-square310x310logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x310.png"><meta name="image" content=""><!-- Open Graph --><meta property="og:title" content="Instrumenting the vSphere Kubernetes Node Image | test-02"><meta property="og:description" content=""><meta property="og:image" content=""><meta property="og:site_name" content="test-02 Help"><meta property="og:type" content="website"><meta property="og:locale" content="en_US"><meta property="og:url" content="writerside-documentation//1.0/instrumenting-vks-node-image.html"><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content=""><meta name="twitter:title" content="Instrumenting the vSphere Kubernetes Node Image | test-02"><meta name="twitter:description" content=""><meta name="twitter:creator" content=""><meta name="twitter:image:src" content=""><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json">{
    "@context": "http://schema.org",
    "@type": "WebPage",
    "@id": "writerside-documentation//1.0/instrumenting-vks-node-image.html#webpage",
    "url": "writerside-documentation//1.0/instrumenting-vks-node-image.html",
    "name": "Instrumenting the vSphere Kubernetes Node Image | test-02",
    "description": "",
    "image": "",
    "inLanguage":"en-US"
}</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json">{
    "@type": "WebSite",
    "@id": "writerside-documentation/#website",
    "url": "writerside-documentation/",
    "name": "test-02 Help"
}</script><!-- End Schema.org --></head><body data-id="Instrumenting-vks-node-image" data-main-title="Instrumenting the vSphere Kubernetes Node Image" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}" data-template="article" data-breadcrumbs=""><div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>test-02 1.0 Help</h3><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="Instrumenting-vks-node-image" id="Instrumenting-vks-node-image.md">Instrumenting the vSphere Kubernetes Node Image</h1><p id="-tn7nn2_3">To monitor Kubernetes security, we typically deploy security monitoring through daemon sets. This daemon set can oversee both the Kubernetes nodes and their workloads. However, some use cases may necessitate a security or vulnerability agent to operate directly on the Kubernetes virtual machine node, and the security and compliance team wants to ensure that this operational policy is enforced across all cluster deployments. For this purpose, we will create a custom VKS node image (also known as Tanzu Kubernetes Release/TKR). This is achieved using the <a href="https://github.com/vmware-tanzu/vsphere-tanzu-kubernetes-grid-image-builder" id="-tn7nn2_7" data-external="true" rel="noopener noreferrer">vSphere Tanzu Kubernetes Grid (TKG) Image Builder</a>. The TKG Image Builder readme provides detailed foundational instructions, which we will follow to configure the Image Builder process.</p><p id="-tn7nn2_4">We will set up a tailored node image featuring an embedded security agent to report potential vulnerabilities to a cloud service that offers a central dashboard. This customized node image will be accessible to the vSphere namespaces designated for cluster creation via the assigned content library. This ensures our security and compliance team can verify that each cluster node is instrumented and configurable for detecting vulnerabilities.</p><section class="chapter"><h2 id="before-you-start" data-toc="before-you-start">Before you start</h2><p id="-tn7nn2_8">It is good practice to list the prerequisites that are required or recommended.</p><p id="-tn7nn2_9">Make sure that you have the following:</p><ul class="list _bullet" id="-tn7nn2_10"><li class="list__item" id="-tn7nn2_11"><p id="-tn7nn2_16">Internet connectivity &ndash; Required to pull the operating system ISO.</p></li><li class="list__item" id="-tn7nn2_12"><p id="-tn7nn2_17">Linux or Mac OS-based workstation with Docker installed.</p></li><li class="list__item" id="-tn7nn2_13"><p id="-tn7nn2_18">DHCP Service &ndash; Assigns IP address to VM during the build process.</p></li><li class="list__item" id="-tn7nn2_14"><p id="-tn7nn2_19">vSphere Cluster or Host &ndash; Build Cluster or host for automated node image build.</p></li><li class="list__item" id="-tn7nn2_15"><p id="-tn7nn2_20"><a href="https://github.com/vmware-tanzu/vsphere-tanzu-kubernetes-grid-image-builder" id="-tn7nn2_21" data-external="true" rel="noopener noreferrer">vSphere TKG Image Builder</a> &ndash; Image builder kit and requirements.</p></li></ul></section><section class="chapter"><h2 id="instrumenting-the-vks-node-image" data-toc="instrumenting-the-vks-node-image">Instrumenting the VKS Node Image</h2><p id="-tn7nn2_22">In this example, I will configure the DataDog Cloud Security Agent to instrument a VKS node image. This procedure can also be used to deploy any node image agent. Here are the steps:</p><ol class="list _decimal" id="-tn7nn2_23" type="1"><li class="list__item" id="-tn7nn2_34"><p id="-tn7nn2_36"><span class="control" id="-tn7nn2_38">vSphere TKG Image Builder Cloning:</span> Clone the vSphere Tanzu Kubernetes Grid Image Builder to your workstation with Docker and prerequisites defined by TKG Builder.</p><div class="code-block" data-lang="bash">
 git clone https://github.com/vmware-tanzu/vsphere-tanzu-kubernetes-grid-image-builder.git
</div></li><li class="list__item" id="-tn7nn2_35"><p id="-tn7nn2_39"><span class="control" id="-tn7nn2_40">Configuring Image Builder:</span> Set up your vSphere cluster or host in the Packer parameter file vsphere.j2. The included vsphere.js file will be a vSphere template to configure your target vSphere environment. (Tip: Host)</p></li></ol><aside class="prompt" data-type="note" data-title="" id="-tn7nn2_24"><p id="-tn7nn2_41"><span class="control" id="-tn7nn2_43">Required vSphere Resources</span></p><p id="-tn7nn2_42">By default the <span class="emphasis" id="-tn7nn2_44">vsphere.j2</span> file will list a vSphere cluster parameter. If a cluster is not available, this cluster specification may be changed to the host parameter. In this case the login credentials may be changed to authenticate directly to the ESXi host.</p></aside><ol class="list _decimal" id="-tn7nn2_25" type="1" start="3"><li class="list__item" id="-tn7nn2_45"><p id="-tn7nn2_48"><span class="control" id="-tn7nn2_49">Optional Step:</span> Configuring the vsphere.j2 file is the minimum requirement for a functional image builder environment. If this is your first image-build project, you can confirm proper workstation configuration by creating a base image before moving on to a customized build. If this test build is successful, we can then create our customized node image. For details and video demonstration, see: <a href="https://github.com/vmware-tanzu/vsphere-tanzu-kubernetes-grid-image-builder?tab=readme-ov-file#building-images" id="-tn7nn2_50" data-external="true" rel="noopener noreferrer">Building Images</a></p></li><li class="list__item" id="-tn7nn2_46"><p id="-tn7nn2_51"><span class="control" id="-tn7nn2_53">Node Image Customization:</span> Our image customization will take place during the Ansible stage of the image build process. As part of an Ansible task, we will incorporate the agent installation steps into the build process. Ansible tasks are defined in the directory <span class="emphasis" id="-tn7nn2_54">[base]/vsphere-tanzu-kubernetes-grid-image-builder-main/ansible/task</span>. Here, we create a simple installation script to install my example DD agent on my VM instance, which will serve as the template for my customized node image. For this Ansible task, I&rsquo;m translating the agent installation script-based steps into an Ansible task. I have named the task YAML <span class="emphasis" id="-tn7nn2_55">dd_agent_install.yml</span>. <figure id="-tn7nn2_56"><img alt="dd_installation" src="images/dd_agent_install.jpg" title="dd_installation" width="1008" height="622"></figure></p><p id="-tn7nn2_52">I must also add this task to the Ansible <span class="emphasis" id="-tn7nn2_57">main.yml</span> located in the same Ansible task directory. <figure id="-tn7nn2_58"><img alt="ansible_main" src="images/ansible-main.jpg" title="ansible_main" width="733" height="893"></figure></p></li><li class="list__item" id="-tn7nn2_47"><p id="-tn7nn2_59"><span class="control" id="-tn7nn2_60">Customization Validation/Testing:</span> We have customized our node image build by adding an embedded cloud security agent installation. We should now verify the successful deployment of the agent. The GOSS testing module of the TKG Image Builder conducts this step. In our scenario, the agent is a systemd-managed process. Therefore, my fundamental GOSS test will confirm that the DD agent&rsquo;s status is running. GOSS test configurations are located in the following directory: [base]/vsphere-tanzu-kubernetes-grid-image-builder-main/goss. I&rsquo;ve named my GOSS YAML configuration goss-datadog-agent.yaml.</p></li></ol><div class="code-block" data-lang="yaml">
service:
  datadog-agent:
    enabled: true
    running: true
</div><p id="-tn7nn2_27">I now append this file to the <span class="emphasis" id="-tn7nn2_61">goos.yaml</span>, located in the same directory. This entry adds my test to the GOSS test stage of the build process.</p><div class="code-block" data-lang="yaml">
# Copyright 2023 VMware, Inc.
# SPDX-License-Identifier: MPL-2.0

gossfile:
  goss-command.yaml: {}
  goss-kernel-params.yaml: {}
  goss-service.yaml: {}
  goss-package.yaml: {}
  goss-files.yaml: {}
  goss-datadog-agent.yaml: {}
</div><aside class="prompt" data-type="warning" data-title="" id="-tn7nn2_29"><p id="-tn7nn2_62"><span class="control" id="-tn7nn2_64">VMware Support of a Customize Node Image</span></p><p id="-tn7nn2_63"><span class="control" id="-tn7nn2_65">Important:</span> VMware will porvide best effort support of a customized node image. For this reason it's important to create GOSS tosts to validate customizations and insure that customizations do not break existing test. <a href="https://github.com/vmware-tanzu/vsphere-tanzu-kubernetes-grid-image-builder?tab=readme-ov-file#support" id="-tn7nn2_66" data-external="true" rel="noopener noreferrer">VMware Support</a></p></aside><ol class="list _decimal" id="-tn7nn2_30" type="1" start="7"><li class="list__item" id="-tn7nn2_67"><p id="-tn7nn2_68"><span class="control" id="-tn7nn2_69">Deploying a Worker Cluster with Custom Node Image:</span> After a successful node image build, the custom node image is downloaded to our build workstation as an OVA into the directory specified in the build command, identified by a specified image suffix. We then upload this image to our TKGR content library. A successful upload is confirmed using the kubectl get tkr command in the vSphere namespace context, and we specify the custom node image in a VKS cluster manifest Managing Cluster Nodes: A successful custom node cluster should register itself with the central management system.</p></li></ol><p id="-tn7nn2_31">Monitoring the build process I note the Cloud Security Agent is deployed. <figure id="-tn7nn2_70"><img alt="Agent Deploy" src="images/dd_build_install.jpg" title="Agent Deploy" width="1425" height="291"></figure></p><p id="-tn7nn2_32">The GOSS systemd test confirms the Cloud Security Agent service is runnings, indicating it will start when the node image is deployed. <figure id="-tn7nn2_71"><img alt="Agent GOSS Test" src="images/ddog_goss_test.jpg" title="Agent GOSS Test" width="1166" height="492"></figure></p><ol class="list _decimal" id="-tn7nn2_33" type="1" start="8"><li class="list__item" id="-tn7nn2_72"><p id="-tn7nn2_73">With a cluster deployed using my custom instrumented node image, I logged into the Datadog portal. The cluster nodes have successfully registered with the Cloud Security portal and the hosts are now monitored for policy-based vulnerabilities. <figure id="-tn7nn2_74"><img alt="DDog-Cloud-Security" src="images/ddog_cloud_securirty.jpg" title="DDog-Cloud-Security" width="1642" height="763"></figure></p></li></ol></section><div class="last-modified">Last modified: 02 April 2025</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom"></div></article><div id="disqus_thread"></div></div></section></main></div><script src="https://resources.jetbrains.com/writerside/apidoc/6.22.0-b725/app.js"></script></body></html>